### 背景及目标

#### 系统：

1. 为了业务维护便捷，提炼抽象各客户的业务需求，用同一套系统满足所有客户的业务需求。
2. 为了同时满足本地和云端两种部署方式，系统需要可配置方便切换和迁移。
3. 设计需要考虑万一需要定制系统的情况，预制解决方案。

#### 数据：

1. 客户数据独立可剥离，支持本地及云端两种部署。租户授权之外的逻辑不依赖云端。
2. 集团类商户可通过云端访问子机构数据。
3. 数据库需要承担租户授权数据的存放。




### 方案

#### 1.数据库

##### 可选方案：

1. 独立数据库实例
2. 共享数据库实例，独立数据库（预方案1）
3. 共享数据库实例和数据库（预方案2）

##### 分析：

1.独立数据库实例

* 部署：1.多服务器单实例；2.单服务器多实例多端口

* 访问路径：1.多IP及端口；2.单IP多端口

* 访问权限：租户访问账号独立，账号权限设置到数据库甚至实例都可以

* 租户数据迁移：整库拷贝，便利。

* 集群子机构数据访问：数据库不通，需要系统暴露访问接口

* 租户授权：数据库不包含租户授权信息，客户端登录系统需要访问额外授权接口。

* 表设计：常规

* 数据结构初始化及升级：

* 瓶颈及扩容：


2.共享数据库实例，独立数据库（预方案1）

- 部署：单服务器单实例多数据库
- 访问路径：同单IP及端口，访问链接带不同数据库名
- 访问权限：租户访问账号独立，账号权限设置到数据库
- 租户数据迁移：整库拷贝，便利。
- 集群子机构数据访问：数据库通，可数据层互访。 1.同集团用同一访问账号，账号对所有子机构数据库访问授权；2.区分集团号和子机构号，区分授权。
- 租户授权：数据库不包含租户授权信息，客户端登录系统需要访问额外授权接口。
- 表设计：常规
- 初始化及升级：
- 瓶颈及扩容：



3.共享数据库实例和数据库（预方案2）

- 部署：单服务器单实例单数据库

- 访问路径：IP、端口、据库名，访问地址完全一致

- 访问权限：1.共用访问账号，由系统保障数据访问隔离；2.区分访问账号，为私有表单独设置访问权限。

- 租户数据迁移：无论是线上线下迁移还是数据剥离独立部署，在数据迁移和系统代码上都需要较大成本。

- 集群子机构数据访问：数据库通，可数据层互访。 通过租户ID或私有表表名互访。

- 租户授权：包含租户授权信息，系统登录即可同时鉴权。

- 表设计：1.租户数据不分表，存租户id；2.租户数据分表，涉及的访问语句区分表名

- 初始化及升级：

- 瓶颈及扩容：

  ​

##### 其他

1.租户个性数据扩展

有的情况，把各租户的需求简单合并，扩展表字段的方式会造成资源浪费，还可能破坏原有表结构。可以引入数据扩展表和数据配置表解决。

**业务表** custom

|  id  | tenant_id | name | age  | …    |
| :--: | :-------: | :--: | :--: | ---- |
|  11  |    112    | Tom  |  12  |      |
|  12  |    112    | Rose |  13  |      |
|  13  |    113    | Jack |  11  |      |

**配置表** config

| conf_no | tenant_id | table  | content | des  |  type  |
| :-----: | :-------: | :----: | :-----: | :--: | :----: |
|    1    |    112    | custom |   job   |  工作  | String |
|    2    |    112    | custom | income  |  收入  |  int   |
|    3    |    113    | custom | address |  地址  | String |

**数据扩展表** extra

| table  | data_id | conf_no | value  |
| :----: | :-----: | :-----: | :----: |
| custom |   11    |    1    |   厨师   |
| custom |   11    |    2    |  5000  |
| custom |   13    |    3    | 北京市朝阳区 |

当某tenant取custom表扩展数据的时候写类似以下sql：

```sql
SELECT ex.data_id, co.content, ex.value 
FROM extra ex INNER JOIN config co ON ex.conf_no = co.conf_no 
WHERE ex.table = ‘custom’ AND co.table = ‘custom’ AND co.tenant_id = 112
```





#### 2.系统设计

1. 租户间独立的用户权限系统
2. ​



#### 3.客户端设计

#### 4.安全保障



